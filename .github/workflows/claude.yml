name: Claude Code

permissions:
  contents: read
  pull-requests: read
  issues: read
  id-token: write
  actions: read

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  # Route to appropriate workflow based on trigger keywords
  route:
    runs-on: ubuntu-latest
    outputs:
      action: ${{ steps.determine-action.outputs.action }}
      pr_number: ${{ steps.determine-action.outputs.pr_number }}
      issue_number: ${{ steps.determine-action.outputs.issue_number }}
      author: ${{ steps.check-permissions.outputs.author }}
      has_access: ${{ steps.check-permissions.outputs.has_access }}
      permission: ${{ steps.check-permissions.outputs.permission }}
    steps:
      - name: Check repository permissions
        id: check-permissions
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMENT_AUTHOR: ${{ github.event.comment.user.login }}
          REVIEW_AUTHOR: ${{ github.event.review.user.login }}
          ISSUE_AUTHOR: ${{ github.event.issue.user.login }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          EVENT_NAME: ${{ github.event_name }}
          REPO: ${{ github.repository }}
        run: |
          # Determine the author based on event type
          AUTHOR=""
          if [[ "$EVENT_NAME" == "issue_comment" || "$EVENT_NAME" == "pull_request_review_comment" ]]; then
            AUTHOR="$COMMENT_AUTHOR"
          elif [[ "$EVENT_NAME" == "pull_request_review" ]]; then
            AUTHOR="$REVIEW_AUTHOR"
          elif [[ "$EVENT_NAME" == "issues" ]]; then
            AUTHOR="$ISSUE_AUTHOR"
          elif [[ "$EVENT_NAME" == "pull_request" ]]; then
            AUTHOR="$PR_AUTHOR"
          fi

          echo "Author: $AUTHOR"
          echo "author=$AUTHOR" >> $GITHUB_OUTPUT

          echo "Checking permissions for $AUTHOR in $REPO..."
          # Check user's permission level in the repository
          PERMISSION=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/$REPO/collaborators/$AUTHOR/permission" \
            --jq '.permission' 2>/dev/null || echo "none")

          echo "Permission level: $PERMISSION"
          echo "permission=$PERMISSION" >> $GITHUB_OUTPUT

          # Check if user has write, maintain, or admin access
          if [[ "$PERMISSION" == "admin" || "$PERMISSION" == "maintain" || "$PERMISSION" == "write" ]]; then
            echo "has_access=true" >> $GITHUB_OUTPUT
            echo "✓ $AUTHOR has sufficient access ($PERMISSION)"
          else
            echo "has_access=false" >> $GITHUB_OUTPUT
            echo "✗ $AUTHOR does not have sufficient access ($PERMISSION)"
          fi

      - name: Determine action
        id: determine-action
        if: steps.check-permissions.outputs.has_access == 'true'
        env:
          EVENT_NAME: ${{ github.event_name }}
          EVENT_ACTION: ${{ github.event.action }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          REVIEW_BODY: ${{ github.event.review.body }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          IS_PULL_REQUEST: ${{ github.event.issue.pull_request != '' }}
        run: |
          ACTION="generic"
          PR_NUM=""
          ISSUE_NUM=""

          # Get the text to check
          TEXT=""
          if [[ "$EVENT_NAME" == "issue_comment" ]]; then
            TEXT="$COMMENT_BODY"
            if [[ "$IS_PULL_REQUEST" == "true" ]]; then
              PR_NUM="$ISSUE_NUMBER"
            else
              ISSUE_NUM="$ISSUE_NUMBER"
            fi
          elif [[ "$EVENT_NAME" == "pull_request_review_comment" ]]; then
            TEXT="$COMMENT_BODY"
            PR_NUM="$PR_NUMBER"
          elif [[ "$EVENT_NAME" == "pull_request_review" ]]; then
            TEXT="$REVIEW_BODY"
            PR_NUM="$PR_NUMBER"
          elif [[ "$EVENT_NAME" == "issues" ]]; then
            TEXT="$ISSUE_BODY $ISSUE_TITLE"
            ISSUE_NUM="$ISSUE_NUMBER"
          fi

          # Skip if no @claude mention and not a label trigger
          if [[ ! "$TEXT" =~ @claude ]] && [[ "$ACTION" == "generic" ]]; then
            echo "No @claude mention found, skipping"
            echo "action=skip" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check for review trigger: @claude + spacing/punctuation + review (case insensitive)
          if echo "$TEXT" | grep -qiE '@claude[[:space:][:punct:]]+review'; then
            ACTION="review"
          # Check for solve trigger: @claude + spacing/punctuation + solve (case insensitive)
          elif echo "$TEXT" | grep -qiE '@claude[[:space:][:punct:]]+solve'; then
            ACTION="solve"
          fi

          echo "action=$ACTION" >> $GITHUB_OUTPUT
          echo "pr_number=$PR_NUM" >> $GITHUB_OUTPUT
          echo "issue_number=$ISSUE_NUM" >> $GITHUB_OUTPUT
          echo "Determined action: $ACTION (PR: $PR_NUM, Issue: $ISSUE_NUM)"

  # Call review workflow
  review:
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    needs: route
    if: needs.route.outputs.action == 'review' && needs.route.outputs.pr_number != ''
    uses: ./.github/workflows/claude-code-review.yml
    with:
      pr_number: ${{ fromJSON(needs.route.outputs.pr_number) }}
    secrets: inherit

  # Call solve workflow
  solve:
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    needs: route
    if: needs.route.outputs.action == 'solve' && needs.route.outputs.issue_number != ''
    uses: ./.github/workflows/claude-solve-issue.yml
    with:
      issue_number: ${{ fromJSON(needs.route.outputs.issue_number) }}
    secrets: inherit

  # Generic Claude workflow (fallback)
  claude:
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    needs: route
    if: needs.route.outputs.action == 'generic'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          # Optional: Give a custom prompt to Claude. If this is not specified, Claude will perform the instructions specified in the comment that tagged it.
          # prompt: 'Update the pull request description to include a summary of changes.'

          # Optional: Add claude_args to customize behavior and configuration
          # See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
          # or https://docs.claude.com/en/docs/claude-code/cli-reference for available options
          claude_args: '--allowed-tools "Bash(gh search:*),Bash(gh issue:*),Bash(gh pr:*),Bash(git add:*),Bash(git commit:*),Bash(git push:*),Bash(git status:*),Bash(git diff:*),Bash(yarn test:*),Bash(yarn lint:*),Bash(yarn build:*)"'
