# Backend

> The current backend uses the Strapi headless CMS. It is scheduled to be migrated to Supabase in H1/2026.

## Preparing backend dependencies

The backend module depends on `@openvaa/app-shared` and you need to build it prior to using `@openvaa/strapi` directly (no need if you use it via Docker):

```bash
yarn workspace @openvaa/app-shared install
yarn workspace @openvaa/app-shared build
```

## Plugins

- Email uses AWS SES, see [Candidate App documentation](candidate-user-management.md#candidate-user-management)
- Upload uses AWS S3, see [plugins.ts](/backend/vaa-strapi/config/plugins.ts)
- [OpenVAA Strapi Admin Tools plugin](#openvaa-admin-tools-plugin-for-strapi) (local plugin)

## Running the backend separately

0. You should be running Strapi with the Node version specified under `engines` in the root [package.json](/package.json). Use of nvm is encouraged. **Additionally, you need Docker!**
1. Install dependencies by running `yarn install`.
2. Copy or rename the `.env.example` to `.env` before running any of the commands.
3. Run `docker compose -f docker-compose.dev.yml up postgres` to start Postgres container.
4. Run `yarn dev` or `yarn start` to run the Strapi server directly.

## Re-generating types

Run `yarn strapi ts:generate-types` to re-generate `types` folder.

## Customized behaviour

The Strapi backend has been customized in many ways to cater to VAA needs. The current implementation is split between direct edits to Strapi code and some functions implemented in the [OpenVAA Admin Tools plugin](#openvaa-admin-tools-plugin-for-strapi). Most of the customizations should be migrated to the plugin in the future.

## Default data loading

Some data is automatically loaded when Strapi is initialized. The data include:

- [Question Types](/backend/vaa-strapi/src/functions/loadDefaultData.ts)
- [App Settings](/backend/vaa-strapi/src/functions/loadDefaultAppSettings.ts)
- [Translation overrides](/backend/vaa-strapi/src/functions/loadDynamicTranslations.ts) (under the `dynamic` key)

API permissions are also set by defaul by [setDefaultApiPermissions.ts](/backend/vaa-strapi/src/functions/setDefaultApiPermissions.ts).

> Note that some of the defaults are **not** loaded if mock data generations is enabled.

## Mock data generation

> NB! This feature must only be used for local development and testing (not on production)

The database can be seeded with generated mock data using Faker.js.

If enabled, the data is generated by the rather messy [generateMockData](/backend/vaa-strapi/src/functions/generateMockData.ts) function. See the implementation for details and constants you can edit in-code to control the amount of data.

Mock data can be seeded only once on initialising the backend DB or on each restart of the Strapi backend. Mock data generation is controlled by these `.env` variables:

```dotenv
# Set to true to enable mock data on an empty database
GENERATE_MOCK_DATA_ON_INITIALISE=true

# Used only in development builds
GENERATE_MOCK_DATA_ON_RESTART=false
```

To enable mock data generation, set the `GENERATE_MOCK_DATA_ON_INITIALISE` variable as true. This will create mock data if the database is empty or give a warning if database is not empty and thus mock data could not be generated.

You can also set `GENERATE_MOCK_DATA_ON_RESTART` as true. This will generate new mock data every time the Strapi instance is restarted.

**Please keep in mind that setting this variable as true will clear the database contents of existing candidates, parties, elections, and so on and should only be used for debugging purposes.**
Setting `GENERATE_MOCK_DATA_ON_RESTART` as true will override `GENERATE_MOCK_DATA_ON_INITIALISE` setting.

**Note:** you need to modify these variables in the relevant `.env` file (located either in the project's root directory or in `backend/vaa-strapi`) depending on how you choose to run the backend service locally.

### Mock users

By default, mock data includes the following Users (for up-to-date details, see [mockUsers](/backend/vaa-strapi/src/functions/mockData/mockUsers.json)):

| User type   | User role     | Email                    | Password     | Remarks                       |
| ----------- | ------------- | ------------------------ | ------------ | ----------------------------- |
| Candidate 1 | Authenticated | `first.last@example.com` | `Password1!` | Use to test the Candidate App |
| Candidate 2 | Authenticated | `test.test@example.com`  | `Password1!` | Use to test the Candidate App |
| Admin       | Admin         | `mock.admin@example.com` | `Password1!` | Use to test the Admin App     |

Note that the mock admin is different from the default Strapi Admin, generated along with mock data.

| User type    | Username | Email               | Password | Remarks                |
| ------------ | -------- | ------------------- | -------- | ---------------------- |
| Strapi Admin | `admin`  | `admin@example.com` | `admin`  | Use to login to Strapi |

## Authentication

Standard read calls require no authentication and are included in the default permissions, which are customized in the [Users’ permissions plugin](/src/extensions/users-permissions/strapi-server.ts).

Furthermore, all API routes are configured

Write calls require authentication:

- For registered Candidates, this is handled by creating a user. Read more in the [Candidate App documentation](candidate-user-management.md#candidate-user-management).
- For pre-registration, an API token with the `users-permissions.candidate.preregister` priviledge is required, which must be saved in the `BACKEND_API_TOKEN` env variable. Read more on creating the token in the [Strapi documenation](https://docs.strapi.io/user-docs/settings/API-tokens#creating-a-new-api-token).

### Adding new content types

If you add new content types that should be accessible, make sure:

1. Edit the `CONTENT_API` list in [api.ts](/backend/vaa-strapi/src/util/api.ts) to grant read rights to the public
2. Add the permission in the [Users’ permissions plugin](/backend/vaa-strapi/src/extensions/users-permissions/strapi-server.ts) so that registered users are granted access sa well
3. Also make sure that the route config includes the default restrictions:

```ts
// /src/api/<COLLECTION>/routes/<COLLECTION>.ts
export default factories.createCoreRouter('api::<COLLECTION>.<COLLECTION>', {
  only: ['find', 'findOne'], // Explicitly disabled create, update, delete
  config: {
    find: {
      policies: ['global::restrict-populate']
    },
    findOne: {
      policies: ['global::restrict-populate']
    }
  }
});
```

## Security

> NB. The Security chapter may be partly outdated.

By default, all content types inside Strapi are assumed to be safe to be publicly exposed. For reading, all the fields except any fields marked with the `private` keyword in their schema definition are returned per how Strapi works. For writing, the majority of the create, update, and delete endpoints are disabled by default unless explicitly used by the candidate application, and otherwise restricted to only resources that belong to the logged in candidate to prevent unauthorized modification of the data.

The restrictions are enforced using policies for each content type's route, usually found in the `backend/vaa-strapi/src/api/[schema]/routes/[schema].ts` file. To simplify this, there are a couple of helper functions available in [acl.ts](`/backend/vaa-strapi/src/util/acl.ts`) and [policies](`/backend/vaa-strapi/src/policies/`). Please see [Strapi's documentation on policies](https://docs.strapi.io/dev-docs/backend-customization/policies#usage) on how to use them.

The default permissions unauthenticated and authenticated users are managed in the [strapi-server.js](/backend/vaa-strapi/src/extensions/users-permissions/strapi-server.js) file, in the `defaultPermissions` array.

### filter-by-candidate

Enforces that all the returned content belongs to the currently authenticated candidate by filtering the `candidate` field. This is primarily meant only for the find and findOne endpoints so that they only return resources belonging to the authenticated candidate in case the content type shouldn't be public for everyone.

Example usage:

```ts
export default factories.createCoreRouter('...', {
  ...
  config: {
    find: {
      policies: [
        'global::filter-by-candidate',
      ],
    },
  },
});
```

### owned-by-candidate

Enforces that the request applies the `candidate` field to the currently authenticated candidate. This is primarily meant only for the create and update endpoints so that the created and updated resources body will always have the candidate set to the authenticated candidate to prevent impersonation.

Example usage:

```ts
export default factories.createCoreRouter('...', {
  ...
  config: {
    create: {
      policies: [
        'global::owned-by-candidate',
      ],
    },
  },
});
```

### restrictPopulate

Enforces that only the allowed populate fields are set to prevent leaking content types from relationships. Strapi does not implement a convenient way to restrict populates, so this would need to be enforced for every content type that is able to eventually return the content type even if there is no direct relationship. For example, if there were the `shop -> pizza -> ingredient` relationship where `ingredient` should not be exposed to the public, it is still possible to use populate to get `ingredient` through the `shop` endpoint using the `shop -> pizza` and `pizza -> ingredient` relationship.

Example usage:

```ts
export default factories.createCoreRouter('...', {
  ...
  config: {
    find: {
      policies: [
        restrictPopulate([
          'pizza', // ?populate[pizza]=true
          'pizza.populate.shop' // ?populate[pizza][populate][shop]=true
        ]),
      ],
    },
  },
});
```

### restrictFilters

Enforces that only the allowed filters are set to prevent leaking content types from relationships. This is useful in scenarios where a specific relationship should not be returned, which filter would allow querying for even though the value is not directly retrievable. For example, user would be able to filter relationship's value by checking the prefix, which would eventually give an oracle where if the character is correct, the content type is returned, or if it's wrong, the content type isn't returned. Repeating this would then allow recovering field values that they shouldn't be able to get.

Example usage:

```ts
export default factories.createCoreRouter('...', {
  ...
  config: {
    find: {
      policies: [
        restrictFilters([
          'candidate.id.$eq', // ?filters[candidate][id][$eq]=1
        ]),
      ],
    },
  },
});
```

### restrictFields

Enforces that only the allowed fields are returned from the content type. If no fields are explicitly provided (using the `?fields=...` syntax in the request), it will default to only providing the allowed fields. This is intended for all the request endpoints as they all return the content type the action is performed on. Note that you should use the `private` field in the content type schema first for increased security (making this redundant), but if that isn't possible then this is an alternative option. This also has same caveats as `restrictPopulate` where the fields will not apply to relationships returned, and the field that shouldn't be returned will still be returned through populate if not carefully restricted.

Example usage:

```ts
export default factories.createCoreRouter('...', {
  ...
  config: {
    find: {
      policies: [
        restrictFields(['id', 'name']), // will allow returning id, name, or a subset of those
      ],
    },
  },
});
```

### restrictBody

Enforces that only the allowed fields are allowed in the body. This is primarily meant only for the create and update endpoints to prevent modifying fields that should not be modified in the content type.

Example usage:

```ts
export default factories.createCoreRouter('...', {
  ...
  config: {
    update: {
      policies: [
        restrictBody(['name']), // will only setting the name field in the body
      ],
    },
  },
});
```

### restrictResourceOwnedByCandidate

Enforces that the accessed resource belongs to the currently authenticated user by verifying that the accessed resource has `candidate` relationship to the authenticated user. This is primarily meant only for the findOne, create, update, and delete endpoints to prevent modification to resources not owned by that candidate. Note that one needs to be careful and make sure that the currently authenticated user is unable to modify another user's resource and set their candidate field to be themselves before performing modifications.

Example usage:

```ts
export default factories.createCoreRouter('api::my-content', {
  ...
  config: {
    update: {
      policies: [
        restrictResourceOwnedByCandidate('api::my-content'), // the content type name is needed for the checks
      ],
    },
  },
});
```

### Preset

Here is a default preset one can use for new content-type that aims to be secure by default:

```ts
export default factories.createCoreRouter('...', {
  only: ['find', 'findOne', 'create', 'update', 'delete'],
  config: {
    find: {
      policies: [
        // Disable populate by default to avoid accidentally leaking data through relations
        restrictPopulate([]),
        // Disable filters by default to avoid accidentally leaking data of relations
        restrictFilters([])
      ]
    },
    findOne: {
      policies: [
        // Disable populate by default to avoid accidentally leaking data through relations
        restrictPopulate([]),
        // Disable filters by default to avoid accidentally leaking data of relations
        restrictFilters([])
      ]
    },
    create: {
      policies: [
        // Enforce ownership to always belong to the candidate
        'global::owned-by-candidate',
        // Disable populate by default to avoid accidentally leaking data through relations
        restrictPopulate([]),
        // Disable filters by default to avoid accidentally leaking data of relations
        restrictFilters([])
      ]
    },
    update: {
      policies: [
        // Allow only updating candidate's own resource
        restrictResourceOwnedByCandidate('...'),
        // Enforce ownership to always belong to the candidate
        'global::owned-by-candidate',
        // Disable populate by default to avoid accidentally leaking data through relations
        restrictPopulate([]),
        // Disable filters by default to avoid accidentally leaking data of relations
        restrictFilters([])
      ]
    },
    delete: {
      policies: [
        // Allow only deleting candidate's own resource
        restrictResourceOwnedByCandidate('api::answer.answer'),
        // Disable populate by default to avoid accidentally leaking data through relations
        restrictPopulate([]),
        // Disable filters by default to avoid accidentally leaking data of relations
        restrictFilters([])
      ]
    }
  }
});
```

Note that if you do not need the create, update, and delete endpoints, one should disable them by removing them from the `only` array.

## OpenVAA admin tools plugin for Strapi

> NB! The name of the plugin in Strapi is `openvaa-admin-tools`.

The plugin combines Strapi admin functions needed by the OpenVAA voting advice application.

### Status: preliminary

Only some of the custom functions are currently contained in the plugin. Functions that should be migrated from the `@openvaa/strapi` include:

- Mock data generation
- Loading default settings and customization
- Candidate registration
- Candidate preregistration

### Installation

The plugin is a local plugin and not currently published as an NPM package.

It is enabled by default in `@openvaa/strapi`’s [plugin config](/backend/vaa-strapi/config/plugins.ts):

```ts
export default ({ env }) => {
  return {
    // Other plugins
    'openvaa-admin-tools': {
      enabled: true,
      resolve: 'src/plugins/openvaa-admin-tools'
    }
  };
};
```

### Developing

1. Enable [hot-reloading](#hot-reloading-the-backend) in Strapi.
2. Watch plugin source for edits by running `yarn workspace @openvaa/strapi-admin-tools watch`.

> NB! Before merging it’s safest to also try the plugin in the production environment as well, because some (unstable) Strapi function may not work there. To do that set `services.strapi.build.target=production` in [docker-compose](/backend/vaa-strapi/docker-compose.dev.yml).

### Usage

The plugin functions are accessed via the Strapi Admin UI. There are currenlty two types of functions:

1. Registration email functions which appear on the right-hand column in the Content manager Candidate list view and single Candidate view.
2. Data import and deletion which are accessed via the admin tool page, which is opened with the jigsaw icon in the main navigation.

The services can also be invoked like any other plugins services with, e.g., `strapi.plugin('openvaa-admin-tools').service('data').import(data)`.

### Functions

#### Registration email

##### Send the registration email to a single Candidate

- UI: Content manager > Candidates > Edit view
- Component: [RegistrationEmailToOne](/backend/vaa-strapi/src/plugins/openvaa-admin-tools/admin/src/components/RegistrationEmailToOne.tsx)
- Service: [`email.sendEmail`](/backend/vaa-strapi/src/plugins/openvaa-admin-tools/server/src/services/email.ts)
- API: `/openvaa-admin-tools/send-email`

Sends a registration link email with customizable content and subject to the Candidate.

Throws if the content does not include the link placeholder.

##### Send the registration email to all unregistered Candidates

- UI: Content manager > Candidates > List view
- Component: [RegistrationEmailToAll](/backend/vaa-strapi/src/plugins/openvaa-admin-tools/adminsrc/components/RegistrationEmailToAll.tsx)
- Service: [`email.sendEmailToUnregistered`](/backend/vaa-strapi/src/plugins/openvaa-admin-tools/server/src/services/email.ts)
- API: `/openvaa-admin-tools//send-email-to-unregistered`
- Required permission: `plugin::openvaa-admin-tools.send-email`

Sends a registration link email with customizable content and subject to all unregisterd Candidates.

Throws if the content does not include the link placeholder.

#### Import and delete data

The `externalId` is a private field that all collection types have which is used to store a stable id which can be referenced instead of the `documentId` in the import and delete functions.

##### Import any data in JSON format

- UI: OpenVAA Admin Tools page
- Component: [ImportData](/backend/vaa-strapi/src/plugins/openvaa-admin-tools/adminsrc/components/ImportData.tsx)
- Service: [`data.import`](/backend/vaa-strapi/src/plugins/openvaa-admin-tools/server/src/services/data.ts)
- API: `/openvaa-admin-tools/import-data`
- Required permission: `plugin::openvaa-admin-tools.import-data`

Import data into Strapi or update existing data based on `externalId` or `documentId` if provided. The data is supplied as `Array`s of `ImportData` objects collected by their collection name.

See the instructions in the component for further info.

##### Delete any data by its `externalId`

- UI: OpenVAA Admin Tools page
- Component: [DeleteData](/backend/vaa-strapi/src/plugins/openvaa-admin-tools/adminsrc/components/DeleteData.tsx)
- Service: [`data.delete`](/backend/vaa-strapi/src/plugins/openvaa-admin-tools/server/src/services/data.ts)
- API: `/openvaa-admin-tools/delete-data`
- Required permission: `plugin::openvaa-admin-tools.import-data`

Delete data based on `externalId`s. Objects whose `externalId`s (specified by collection) start with the provided, case-sensitive prefixes will be deleted. Mostly useful for deleting mock data which is generated with `externalId`s starting with `mock-`.

See the instructions in the component for further info.

##### Find any data using `filters`

- UI: OpenVAA Admin Tools page
- Component: [FindData](/backend/vaa-strapi/src/plugins/openvaa-admin-tools/adminsrc/components/FindData.tsx)
- Service: [`data.find`](/backend/vaa-strapi/src/plugins/openvaa-admin-tools/server/src/services/data.ts)
- API: `/openvaa-admin-tools/find-data`
- Required permission: `plugin::openvaa-admin-tools.import-data`

Find any data accessible by the data tools by providing arbitrary filters. You can also select the relations to populate.

See the instructions in the component for further info.

##### Send email to selected Candidates

- UI: OpenVAA Admin Tools page
- Component: [SendEmail](/backend/vaa-strapi/src/plugins/openvaa-admin-tools/adminsrc/components/SendEmail.tsx)
- Services:
  - [`data.findCandidates`](/backend/vaa-strapi/src/plugins/openvaa-admin-tools/server/src/services/data.ts)
  - [`email.sendEmail`](/backend/vaa-strapi/src/plugins/openvaa-admin-tools/server/src/services/email.ts)
- APIs:
  - `/openvaa-admin-tools/find-candidates`
  - `/openvaa-admin-tools/send-email`
- Required permissions:
  - `plugin::openvaa-admin-tools.import-data`
  - `plugin::openvaa-admin-tools.send-email`

A tool that combines searching for Candidates to build an editable list to whom to send emails.

See the instructions in the component for further info.

### Access control

In addition to the specified permissions, all routes require `admin::isAuthenticatedAdmin`, see [route policies](/backend/vaa-strapi/src/plugins/openvaa-admin-tools/server/src/routes/admin/index.ts).
