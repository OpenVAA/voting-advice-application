import {Candidate, Election, Updatable} from './internal';
import type {
  CandidateData,
  ElectionData,
  Id,
  Collection,
  Party,
  MappedCollection
} from './internal';
import {order} from './order';

/*
 * DataRoot is the root for all of the DataObjects. Data passed by the DataProvider is passed to the DataRoot, which converts it into DataObjects and organises them.
 */
export class DataRoot extends Updatable {
  /**
   * These can be set to change the way data is formatted by accessors depending on, e.g., locale. NB. If the object data already contains the target property, it will take precedence over that generated by a formatter.
   */
  format = {
    initials: formatInitials,
    name: formatName
  };

  protected children: {
    elections?: Collection<Election>;
    candidates?: MappedCollection<Candidate>;
    parties?: MappedCollection<Party>;
  } = {};

  constructor() {
    super(null);
  }

  get candidates(): Collection<Candidate> | undefined {
    return this.children.candidates
      ? [...this.children.candidates.values()].sort(order)
      : undefined;
  }

  get elections(): Collection<Election> | undefined {
    return this.children.elections ? [...this.children.elections] : undefined;
  }

  getCandidate(id: Id): Candidate | undefined {
    return this.children.candidates?.get(`${id}`);
  }

  getParty(id: Id): Party | undefined {
    return this.children.parties?.get(`${id}`);
  }

  /**
   * Provide election data to the DataRoot. Can only be called once unless reset.
   */
  provideElectionData(data: Readonly<Array<ElectionData>>): void {
    if (!this.children.elections)
      console.info(`[debug] DataRoot.provideElectionData() with ${data.length} elections`);
    if (!this.children.elections)
      this.update(
        () => (this.children.elections = [...data].sort(order).map((d) => new Election(d, this)))
      );
  }

  /**
   * Provide the candidate data to the DataRoot. Note that already existing candidates will not be replaced.
   */
  provideCandidateData(data: Readonly<Array<CandidateData>>): void {
    if (this.children.candidates) {
      data = data.filter((d) => !this.children.candidates!.has(`${d.id}`));
    } else {
      this.children.candidates = new Map();
    }
    if (data.length)
      console.info(
        `[debug] DataRoot.provideCandidateData() with ${data.length} new candidates`,
        data.map((d) => d.firstName)
      );
    // TODO: Link parties and other entities to the candidates
    if (data.length)
      this.update(() =>
        data.forEach((d) => this.children.candidates!.set(`${d.id}`, new Candidate(d, this)))
      );
  }
}

/**
 * Creates intials for a candidate.
 * @example Ben Johnson => BJ
 * @example Johan af Gran' => JaG
 */
export function formatInitials(candidate: Candidate): string {
  return `${candidate.firstName} ${candidate.lastName}`
    .split(/ +/)
    .map((word) => `${word.substring(0, 1)}`)
    .join('');
}

export function formatName(candidate: Candidate): string {
  return `${candidate.firstName} ${candidate.lastName}`;
}
